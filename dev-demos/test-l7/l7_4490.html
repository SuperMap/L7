<!--********************************************************************
* Copyright© 2000 - 2023 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!--********************************************************************
* 该示例需要引入 
* G6 (https://github.com/antvis/G6)
*********************************************************************-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>4490</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
      }
      #map {
        width: 100%;
        height: 100%;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="../js/iclient-mapboxgl.css"></link>
    <script type="text/javascript" src="./js/mapbox-gl-enhance.js"></script>
    <script type="text/javascript" src="../../mapboxgl-l7-render/dist/index.js"></script> <!-- l7-mapboxgl -->
    <script type="text/javascript" src="../js/iclient-mapboxgl-es6.js"></script>
  </head>

  <body>
    <div id="map"></div>
    <script type="text/javascript">
      var host = window.isLocal ? window.server : 'https://iserver.supermap.io';
      var attribution =
        "<a href='https://www.mapbox.com/about/maps/' target='_blank'>© Mapbox </a>" +
        " with <span>© <a href='https://iclient.supermap.io' target='_blank'>SuperMap iClient</a> | </span>" +
        " Map Data <span>© <a href='http://support.supermap.com.cn/product/iServer.aspx' target='_blank'>SuperMap iServer</a></span> ";

      var url = host + '/iserver/services/map-china400/rest/maps/China_4490';
      var features = {
        type: 'FeatureCollection',
        features: [
          {
            type: 'Feature',
            properties: {length: 10, level:43, "value": -4},
            geometry: {
              type: 'LineString',
              coordinates: [
                [100, 10],
                [100.05, 10.05]
              ]
            }
          }
        ]
      };
      var map = new mapboxgl.Map({
        container: 'map', // container id
        style: {
          version: 8,
          sources: {
            'raster-tiles': {
              type: 'raster',
              tileSize: 256,
              tiles: [url],
              rasterSource: 'iserver'
            }
          },

          layers: [
            {
              id: 'simple-tiles',
              type: 'raster',
              source: 'raster-tiles',
              minzoom: 0,
              maxzoom: 22
            }
          ]
        },
        crs: 'EPSG:4490',
        center: [100, 10],
        zoom: 8
      });

      map.on('load', () => {
        window.map = map;
        var data = [
            {
              w: 10,
              t: 24.6,
              s: '海南',
              l: 20,
              m: '东方',
              j: 100,
              h: 61407,
              mag:8.4,
              "capacity": 67200,
              v:1,
              "name": "铁路新村(华池路)",
              "icon": "icon1"
            },
            {
              w: 10.05,
              t: 24.6,
              s: '海南',
              l: 18,
              m: '东方',
              j: 100.05,
              h: 59838,
              v:2,
              mag:8.4,
              "capacity": 6720,
              "name": "金元坊",
              "icon": "icon1"
            }
          ];

          var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
          var l7Layer = layer.getL7Layer();
          data.forEach((item) => {
            const { j: lng, w: lat } = item;
            new mapboxgl.Marker().setLngLat([lng, lat]).addTo(map);
          });
          l7Layer
            .source(data, {
              parser: {
                type: 'json',
                x: 'j',
                y: 'w'
              }
            })
            .shape('circle')
            .size(10)
            .color('red');
          const source = {
            type: 'geojson',
            data: features
          };
          const layer1 = {
            id: 'line',
            type: 'line',
            source,
            paint: {
              'line-color': 'green',
              'line-width': 20
            }
          };

          const source2 = {
            type: 'geojson',
            data: {
              type: 'FeatureCollection',
              features: [
                {
                  type: 'Feature',
                  properties: { "name": "Alabama", 'h20': 11},
                  geometry: {
                    type: 'MultiPolygon',
                    coordinates: [[
                      [
                        [100.06, 10],
                        [99.95, 10],
                        [100.06, 10.06],
                        [100.06, 10]
                      ]
                    ]]
                  }
                }
              ]
            }
          };
          const layer2 = {
            id: 'fill',
            type: 'fill',
            source: source2,
            paint: {
              'fill-color': 'rgba(255, 255, 0, 1)'
            }
          };
          const pointSource = {
            type: 'geojson',
            data: {
              type: 'FeatureCollection',
              features: [
                {
                  type: 'Feature',
                  properties: {},
                  geometry: {
                    type: 'Point',
                    coordinates: [100.05, 10.05]
                  }
                },
                {
                  type: 'Feature',
                  properties: {},
                  geometry: {
                    type: 'Point',
                    coordinates: [100, 10]
                  }
                }
              ]
            }
          };

          const layer3 = {
            id: 'circle',
            type: 'circle',
            source: pointSource,
            paint: {
              'circle-radius': 12,
              'circle-color': 'blue',
              'circle-opacity': 1
            }
          };
          var LineLayer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' });
          LineLayer.getL7Layer().source(source.data).color('pink').shape('line').size(6);

          var polygonlayer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer' });
          var l7Layer3 = polygonlayer.getL7Layer();

          l7Layer3.source(source2.data).color('green').shape('fill');

          // map.addLayer(layer1);
          // map.addLayer(layer2);
          // map.addLayer(layer3);
          // map.addLayer(polygonlayer);
          // map.addLayer(LineLayer);
        // map.addLayer(layer);
        // create3DColumnLayer(data, map)
        // creaWallLine(source.data, map)
        // creatTextPolygon(source2.data, map)
        // creategrid(data, map)
        createMvtLayer(map)
        map.getL7Scene().then(scene=>{
            scene.on('click', (ev) => {
              console.log(ev)
            });
        })
        l7Layer.on('click', (e) => {
          console.log('layer: ',e)
        });
      });

      function create3DColumnLayer(data, map) {
          var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
          var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
            parser: {
              type: 'json',
              x: 'j',
              y: 'w'
            }
          }).shape('name', [
            'cylinder',
            'triangleColumn',
            'hexagonColumn',
            'squareColumn'
          ])
          .size('h', h => {
            return [ 6, 6, h / 500 ];
          })
          .color('name', [ '#739DFF', '#61FCBF', '#FFDE74', '#FF896F' ]);
          map.addLayer(layer);
      }
   
     function createShpePoint(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('name', [
          'circle',
          'triangle',
          'square',
          'pentagon',
          'hexagon',
          'octogon',
          'hexagram',
          'rhombus',
          'vesica'
        ])
        .size('l', [ 10, 25 ])
        .active(true)
        .color('name', [ '#5B8FF9', '#5CCEA1', '#5D7092', '#F6BD16', '#E86452' ])
        .style({
          opacity: 0.8,
          strokeWidth: 2
        });
        map.addLayer(layer);
     }
   
     function createAnimatePoint(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('circle')
        .active(true)
        .animate(true)
        .size(40)
        .color('#ffa842')
        .style({
          // offsets: [ 40, 40 ]
        });
        map.addLayer(layer);
     }

     function creatRadarPoint(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('radar')
        .size(100)
        .color('#d00')
        .style({
          speed: 5
        })
        .animate(true);
        map.addLayer(layer);
     }
   
     // bug 面的文本 zoom>2不显示
     function creatTextPoint(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('name', 'text')
        .size(50)
        .color('#084081')
        .style({
          textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
          textOffset: [ 0, 0 ], // 文本相对锚点的偏移量 [水平, 垂直]
          spacing: 2, // 字符间距
          padding: [ 1, 1 ], // 文本包围盒 padding [水平，垂直]，影响碰撞检测结果，避免相邻文本靠的太近
          stroke: '#ffffff', // 描边颜色
          strokeWidth: 2, // 描边宽度
          strokeOpacity: 1.0,
          // rotation: 60, // 常量旋转
          rotation:{ // 字段映射旋转
            field: 't',
            value:[30,270]
          }
        });
        map.addLayer(layer);
     }
   
     // bug 面的文本 zoom>2不显示
     function creatTextPolygon(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data)
        .color('blue')
        .shape('name', 'text')
        .size(18)
        .style({
          textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
          textOffset: [ 0, 0 ], // 文本相对锚点的偏移量 [水平, 垂直]
          spacing: 2, // 字符间距
          padding: [ 1, 1 ], // 文本包围盒 padding [水平，垂直]，影响碰撞检测结果，避免相邻文本靠的太近
          stroke: '#ffffff', // 描边颜色
          strokeWidth: 0.3, // 描边宽度
          strokeOpacity: 1.0
        });
        map.addLayer(layer);
     }

     function creatIconPoint(data, map) {
      map.getL7Scene().then(scene=>{
        const fontFamily = 'iconfont';
        const fontPath = '//at.alicdn.com/t/font_2534097_fcae9o2mxbv.woff2?t=1622200439140';
        scene.addFontFace(fontFamily, fontPath);
        scene.addIconFont('icon1', '&#xe6d4;');
        scene.once('fontloaded', () => {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('icon', 'text')
        .size(20)
        .color('w', [ '#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99' ])
        .style({
          textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
          // padding: [ 0, 0 ], // 文本包围盒 padding [水平，垂直]，影响碰撞检测结果，避免相邻文本靠的太近
          stroke: '#ffffff', // 描边颜色
          fontFamily,
          iconfont: true,
          textAllowOverlap: true
        });
        map.addLayer(layer);
      })
      })
     }
   
     function creatIconTempPoint(data, map) {
      map.getL7Scene().then(scene=>{
        const fontFamily = 'iconfont';
        const fontPath =
          '//at.alicdn.com/t/font_2534097_x6rsov3i1g.woff2?t=1622107341225';
        scene.addIconFont('icon1', '&#xe69e;');
        scene.addFontFace(fontFamily, fontPath);

        const colors = [
          '#87CEFA',
          '#00BFFF',

          '#7FFFAA',
          '#00FF7F',
          '#32CD32',

          '#F0E68C',
          '#FFD700',

          '#FF7F50',
          '#FF6347',
          '#FF0000'
        ];

        scene.once('fontloaded', () => {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('icon', 'text')
        .size(25)
        .style({
          textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
          textOffset: [ -25, 15 ],
          padding: [ 2, 2 ],
          fontFamily,
          iconfont: true,
          textAllowOverlap: true
        });
        map.addLayer(layer);
      })
      })
     }
   
     function creatImagePoint(data, map) {
      map.getL7Scene().then(scene=>{
        scene.addImage(
          '00',
          'https://gw.alipayobjects.com/zos/basement_prod/604b5e7f-309e-40db-b95b-4fac746c5153.svg'
        );
        scene.addImage(
          '01',
          'https://gw.alipayobjects.com/zos/basement_prod/30580bc9-506f-4438-8c1a-744e082054ec.svg'
        );
        scene.addImage(
          '02',
          'https://gw.alipayobjects.com/zos/basement_prod/7aa1f460-9f9f-499f-afdf-13424aa26bbf.svg'
        );

        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('name', [ '00', '01', '02' ])
        .size(10);
        map.addLayer(layer);
      })
     }

     function creatPathLine(data, map) {
      var data1 = [
        {
          "level": 2,
          "number": "902",
          "path": [
            [
            100,
              10,
              420000
            ],
            [
            100.05, 10.05,
              420000
            ]
          ]
        }
      ]
        var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data1, {
          parser: {
            type: 'json',
            coordinates: 'path'
          }
        })
          .size('level', level => {
            return [ 0.8, level * 0.1 ];
          })
        .shape('line')
        .active(true)
        .color('number', [
          '#0A3663',
          '#1558AC',
          '#3771D9',
          '#4D89E5',
          '#64A5D3',
          '#72BED6',
          '#83CED6',
          '#A6E1E0',
          '#B8EFE2',
          '#D7F9F0'
        ]);
        map.addLayer(layer);
     }
   
     function crea3dArcLine(data, map) {
      var data1 = [
            {
          "tripduration": 452,
          "starttime": "2017-12-01 00:00:59",
          "stoptime": "2017-12-01 00:08:32",
          "start station id": 3183,
          "start station name": "Exchange Place",
          "start station latitude": 10,
          "start station longitude": 100,
          "end station id": 3199,
          "end station name": "Newport Pkwy",
          "end station latitude": 10.05,
          "end station longitude": 100.05,
          "bikeid": 29607,
          "usertype": "Subscriber",
          "birth year": 1988,
          "gender": 1
        },
      ]
        var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' ,options:{ blend: 'normal'}}, );
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data1, {
          parser: {
            type: 'json',
            x: 'start station longitude',
            y: 'start station latitude',
            x1: 'end station longitude',
            y1: 'end station latitude'
          }
        })
        .size(2)
        .shape('arc3d')
        .color('red')
        // .animate({
        //   interval: 0.5,
        //   trailLength: 0.5,
        //   duration: 5
        // })
        .style({
          opacity: 1
        });
        map.addLayer(layer);
     }
   
     function creahighLine(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' ,options:{ blend: 'normal'}}, );
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data)
        .scale('value', {
          type: 'quantile'
        })
        .size('value', [ 0.5, 1, 1.5, 2 ])
        .shape('line')
        .color(
          'value',
          [
            '#0A3663',
            '#1558AC',
            '#3771D9',
            '#4D89E5',
            '#64A5D3',
            '#72BED6',
            '#83CED6',
            '#A6E1E0',
            '#B8EFE2',
            '#D7F9F0'
          ].reverse()
        );
        map.addLayer(layer);
     }

     function creaWallLine(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' ,options:{ blend: 'normal'}}, );
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data)
          .size(40)
        .shape('wall')
        .style({
          heightfixed: true,
          opacity: 1,
          sourceColor: '#0DCCFF',
          targetColor: 'rbga(255,255,255, 0)'
        });
        map.addLayer(layer);
     }
   
     function crea3DExtrude(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data)
          .shape('extrude')
          .size(50000)
          .color('red');
        map.addLayer(layer);
     }

     function createHeat(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data,{parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }})
          .shape('heatmap')
        .size('mag', [ 0, 1.0 ]) // weight映射通道
        .style({
          intensity: 2,
          radius: 20,
          rampColors: {
            colors: [
              '#FF4818',
              '#F7B74A',
              '#FFF598',
              '#91EABC',
              '#2EA9A1',
              '#206C7C'
            ].reverse(),
            positions: [ 0, 0.2, 0.4, 0.6, 0.8, 1.0 ]
          }
        });
        map.addLayer(layer);
     }

      // bug 3d热力图显示闪烁， 图像不成3d热力图
     function createheatmap3D(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data,{parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }})
          .size('capacity', [ 0, 1 ])
        .shape('heatmap3D')
      // weight映射通道
        .style({
          intensity: 5,
          radius: 10,
          rampColors: {
            colors: [
              '#2E8AE6',
              '#69D1AB',
              '#DAF291',
              '#FFD591',
              '#FF7A45',
              '#CF1D49'
            ],
            positions: [ 0, 0.2, 0.4, 0.6, 0.8, 1.0 ]
          }
        });
        map.addLayer(layer);
     }
   
     // bug 格网图不显示
     function creategrid(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          },
          transforms: [
            {
              type: 'grid',
              size: 200000,
              field: 'v',
              method: 'sum'
            }
          ]
        })
        .shape('square')
        .style({
          coverage: 1,
          angle: 0
        })
        .color('red');
        map.addLayer(layer);
     }
  
     // bug 格网3d图不显示
     function creategrid3D(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          },
          transforms: [
            {
              type: 'hexagon',
              size: 25000,
              field: 'v',
              method: 'sum'
            }
          ]
        })
        .size('V', sum => {
          return sum * 200;
        })
        .shape('hexagonColumn')
        .style({
          coverage: 0.8,
          angle: 0,
        })
        .color('sum', [
          '#094D4A',
          '#146968',
          '#1D7F7E',
          '#289899',
          '#34B6B7',
          '#4AC5AF',
          '#5FD3A6',
          '#7BE39E',
          '#A1EDB8',
          '#C3F9CC',
          '#DEFAC0',
          '#ECFFB1'
        ]);
        map.addLayer(layer);
     }
   
     // bug 矢量瓦片卡顿
     function createMvtLayer(map) {
        const url = 'https://mvt.amap.com/district/CHN2/{z}/{x}/{y}/4096?key=309f07ac6bc48160e80b480ae511e1e9&version=';
          const source = new L7.Source(url, {
            parser: {
              type: 'mvt',
              tileSize: 256,
              warp: false
            }
          });
          const colors = {};
          const GDPSpeed = {
            520000: 10, //贵州
            540000: 10, //西藏
            530000: 8.5, //云南
            500000: 8.5, //重庆
            360000: 8.5, //江西
            340000: 8.0, //安徽
            510000: 7.5, //四川
            350000: 8.5, //福建
            430000: 8.0, //湖南
            420000: 7.5, //湖北
            410000: 7.5, //河南
            330000: 7.0, //浙江
            640000: 7.5, //宁夏
            650000: 7.0, //新疆
            440000: 7.0, //广东
            370000: 7.0, //山东
            450000: 7.3, //广西
            630000: 7.0, //青海
            320000: 7.0, //江苏
            140000: 6.5, //山西
            460000: 7, // 海南
            310000: 6.5, //上海
            110000: 6.5, // 北京
            130000: 6.5, // 河北
            230000: 6, // 黑龙江
            220000: 6, // 吉林
            210000: 6.5, //辽宁
            150000: 6.5, //内蒙古
            120000: 5, // 天津
            620000: 6, // 甘肃
            610000: 8.5, // 甘肃
            710000: 6.64, //台湾
            810000: 6.0, //香港
            820000: 6.7 //澳门
          };
          const getColorByDGP = function (adcode) {
            if (!colors[adcode]) {
              const gdp = GDPSpeed[adcode];
              if (!gdp) {
                colors[adcode] = 'rgb(227,227,227)';
              } else {
                const rg = 255 - Math.floor(((gdp - 5) / 5) * 255);
                colors[adcode] = 'rgb(' + rg + ',' + rg + ',255)';
              }
            }
            return colors[adcode];
          };
          var fill = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer', options: { sourceLayer: 'CHN_Cities' } });
          fill.getL7Layer().source(source).shape('fill').color('adcode_pro', getColorByDGP);

          var line = new mapboxgl.supermap.L7Layer({ type: 'LineLayer', options: { sourceLayer: 'CHN_Cities_L' } });
          line.getL7Layer().source(source).shape('line').color('#FFA500');

          var line2 = new mapboxgl.supermap.L7Layer({ type: 'LineLayer', options: { sourceLayer: 'CHN_L' } });
          line2.getL7Layer().source(source).shape('line').size(0.6).color('#053061');

          var line3 = new mapboxgl.supermap.L7Layer({
            type: 'PointLayer',
            options: { sourceLayer: 'CHN_Cities', blend: 'normal' }
          });
          line3.getL7Layer().source(source).shape('id', 'text').size(12).color('#000');

          map.addLayer(fill);
          map.addLayer(line);
          map.addLayer(line2);
          map.addLayer(line3);
      }
    
   </script>
  </body>
</html>
