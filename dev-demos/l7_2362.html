<!--********************************************************************
* Copyright© 2000 - 2023 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!--********************************************************************
* 该示例需要引入 
* G6 (https://github.com/antvis/G6)
*********************************************************************-->
<!DOCTYPE html>
<html>
  <link>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>2362</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      #buttons {
        position: fixed;
        top:10px;
        padding:10px;
        width: 100%;
        display: flex;
        flex-flow: wrap
      }
      #buttons button {
        display: block;
        width: 120px;
        margin: 10px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@antv/g2@4.2.8/dist/g2.min.js"></script>

    <link rel="stylesheet" type="text/css" href="./js/iclient-mapboxgl.css">
    </link>
    <script type="text/javascript" src="./js/mapbox-gl-enhance.js"></script>
    <script type="text/javascript" src="../mapboxgl-l7-render/dist/index.js"></script>
    <script type="text/javascript" src="./js/iclient-mapboxgl-es6.js"></script>
  </head>

  <body>
    <div id="map"></div>
    <div id="buttons"></div>
    <script type="text/javascript">
      var host = window.isLocal ? window.server : 'https://iserver.supermap.io';
      var attribution =
        "<a href='https://www.mapbox.com/about/maps/' target='_blank'>© Mapbox </a>" +
        " with <span>© <a href='https://iclient.supermap.io' target='_blank'>SuperMap iClient</a> | </span>" +
        " Map Data <span>© <a href='http://support.supermap.com.cn/product/iServer.aspx' target='_blank'>SuperMap iServer</a></span> ";

      var tileURL = host + '/iserver/services/map-china400/rest/maps/ChinaDark/zxyTileImage.png?z={z}&x={x}&y={y}';
      mapboxgl.supermap
        .initMap(host + '/iserver/services/map-mvt-landuse/rest/maps/landuse', {
          type: 'vector-tile',
          mapOptions: {
            zoom: 10,
            pitch: 90
          }
        })
        .then(function (result) {
          var map = result.map;
          window.map = map;
          var data = [
            {
              w: 23.826245,
              t: 24.6,
              s: '海南',
              l: 11,
              m: '东方',
              j: 108.9131417,
              h: 59838,
              v:2,
              mag:8.4,
              value:1,
              name:'01',
              "capacity": 67200,
              "name": "金元坊",
              "icon": "icon1"
            },
            {
              w: 23.85,
              t: 24,
              s: '海',
              l: 12,
              m: '东',
              j: 108.85,
              h: 59838,
              v:2,
              mag:8.4,
              value:2,
              name:'02',
              "capacity": 6720,
              "name": "金元坊",
              "icon": "icon1"
            }
          ];
          var features = {
            type: 'FeatureCollection',
            features: [
              {
                type: 'Feature',
                properties: {length: 10, level:43, "value": -4},
                geometry: {
                  type: 'LineString',
                  coordinates: [
                    [108.9131417, 23.826245],
                    [108.85, 23.85]
                  ]
                }
              }
            ]
          };
          const source = {
            type: 'geojson',
            data: features
          };
          const source2 = {
            type: 'geojson',
            data: {
              type: 'FeatureCollection',
              features: [
                {
                  type: 'Feature',
                  properties: { "name": "Alabama", 'h20': 11},
                  geometry: {
                    type: 'MultiPolygon',
                    coordinates: [[
                      [
                        [108.85, 23.85],
                        [108.9131417, 23.826245],
                        [108.85, 23.9],
                        [108.85, 23.85]
                        // [30, 23],
                        // [109, 23],
                        // [109, 24],
                        // [30, 24],
                      ]
                    ]]
                  }
                }
              ]
            }
          };
          
          // map.on('load', () => {
            console.log('load');
            window.map = map;
            var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
            var l7Layer = layer.getL7Layer();
            data.forEach((item) => {
              const { j: lng, w: lat } = item;
              new mapboxgl.Marker().setLngLat([lng, lat]).addTo(map);
            });
            l7Layer
              .source(data, {
                parser: {
                  type: 'json',
                  x: 'j',
                  y: 'w'
                }
              })
              .shape('circle')
              .size(10)
              .color('red');

            var polygonlayer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer' });
            var l7Layer3 = polygonlayer.getL7Layer();
            l7Layer3.source(source2.data).color('red').shape('fill');

            // map.addLayer(layer);
            console.log('----------======----')
            map.getL7Scene().then(scene=>{
              console.log('--------------')
              createButtons(data, source, source2, scene)
            })
            l7Layer.on('click', (e) => {
              console.log('layer: ',e)
            });
            
          // });
         
      });
      function createButtons(data, source, source2,scene) {
        const btns = {
            creatIconPoint:()=>creatIconPoint(data, map),
            creaWallLine:()=>creaWallLine(source.data, map),
            creatTextPolygon:()=>creatTextPolygon(source2.data, map),
            create3DColumnLayer:()=>create3DColumnLayer(data, map),
            createAnimatePoint:()=>createAnimatePoint(data, map),
            createShpePoint:()=>createShpePoint(data, map),
            creatRadarPoint:()=>creatRadarPoint(data, map),
            creatTextPoint:()=>creatTextPoint(data, map),
            creatImagePoint:()=>creatImagePoint(data, map),
            creatPathLine:()=>creatPathLine(data, map),
            crea3dArcLine:()=>crea3dArcLine(data, map),
            creahighLine:()=>creahighLine(source.data, map),
            crea3DExtrude:()=>crea3DExtrude(source2.data, map),
            createHeat:()=>createHeat(data, map),
            createheatmap3D:()=>createheatmap3D(data, map),
            creategrid:()=>creategrid(data, map),
            creategrid3D:()=>creategrid3D(data, map),
            createMvtLayer:()=>createMvtLayer(map),
            createOcean: ()=>createOcean(source2.data, map,),
            createWater: ()=>createWater(source2.data, map),
            createCityBuildings: ()=>createCityBuildings(data, map),
            creatRain: ()=>creatRain(data, map),
            addChart: () => addChart(scene,map),
            createOD_MS: () => createOD_MS(map,scene,),
            createOD: () => createOD(map,scene,),
            createHexagonColumn: () => createHexagonColumn(map,data),
            createGridMap: () => createGridMap(map,data),
            createCircleArc: () => createCircleArc(map,),
            createWindAnimate: () => createWindAnimate(map,),
            createLineAnimate: () => createLineAnimate(map,),

          }
        

          const parentDom = document.querySelector('#buttons')
          Object.keys(btns).map(key=>{
            const btn = document.createElement('button');
            btn.id = key;
            btn.onclick =  btns[key]
            btn.innerHTML = key;
            parentDom.appendChild(btn)
          })
         
        }

        // 3d蜂窝热力图出现两条横杠
function createHexagonColumn(map, data) {
  fetch('./js/7359a5e9-3c5e-453f-b207-bc892fb23b84.csv')
    .then((res) => res.text())
    .then((data1) => {
      var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
      var l7Layer = layer.getL7Layer();
      console.log(data)
      l7Layer
        .source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w',
          },
          transforms: [
            {
              type: 'hexagon',
              size: 2000,
              field: 'v',
              method: 'sum',
            },
          ],
        })
        .size(100)
        .shape('hexagonColumn')
        .color(
          'count',
          [
            '#FF4818',
            '#F7B74A',
            '#FFF598',
            '#FF40F3',
            '#9415FF',
            '#421EB2',
          ].reverse(),
        )
        .style({
          coverage: 0.9,
          angle: 0,
        });
      map.addLayer(layer);
    });
}
// 格网地图出现两条横杠
function createGridMap(map,data) {
  fetch('./js/3dadb1f5-8f54-4449-8206-72db6e142c40.json')
    .then((res) => res.json())
    .then((data1) => {
      var linelayer = new mapboxgl.supermap.L7Layer({
        type: 'HeatmapLayer',
        options: { autoFit: true },
      });
      linelayer
        .getL7Layer()
        .source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w',
          },
          transforms: [
            {
              type: 'hexagon',
              size: 5 * 100000,
            },
          ],
        })
        .shape('circle')
        .active(false)
        .color('red')
        .style({
          coverage: 0.7,
          angle: 0,
        });
      map.addLayer(linelayer);
    });
}
// 大圆航线没绘制
function createCircleArc(map) {
  fetch('./js/UEXQMifxtkQlYfChpPwT1.txt')
    .then((res) => res.text())
    .then((data) => {
      var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' });
      var l7Layer = layer.getL7Layer();
    console.log(data)

      l7Layer
        .source(data, {
          parser: {
            type: 'csv',
            x: 'lng1',
            y: 'lat1',
            x1: 'lng2',
            y1: 'lat2',
          },
        })
        .size(20)
        .shape('greatcircle')
        .color('#8C1EB2')
        .style({
          // opacity: 0.8,
          // lineType: 'solid',
          // opacity: 1,
          // dashArray: [1, 0],
          // iconStep: 20,
          segmentNumber: 50,
        })
        .animate(true);
      map.addLayer(layer);
      setTimeout(() => {
        console.log('stylechange segmentNumbersegmentNumber');
        l7Layer.style({ segmentNumber: 50 });
        // layer.reRender();
      }, 2000);

      // var layer1 = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' });
      // var l7Layer1 = layer1.getL7Layer();
      // l7Layer1
      //   .source(data, {
      //     parser: {
      //       type: 'csv',
      //       x: 'lng1',
      //       y: 'lat1',
      //       x1: 'lng2',
      //       y1: 'lat2',
      //     },
      //   })
      //   .size(1)
      //   .shape('greatcircle')
      //   .color('red')
      //   .style({
      //     // opacity: 0.8,
      //     // // lineType: 'solid',
      //     // // opacity: 1,
      //     // dashArray: [1, 0],
      //     // iconStep: 20,
      //   });
      // map.addLayer(layer1);
    });
}
// 风场动画 动画效果不对
function createWindAnimate(map) {
  fetch('./js/7455fead-1dc0-458d-b91a-fb4cf99e701e.txt')
    .then((res) => res.text())
    .then((data) => {
      var linelayer = new mapboxgl.supermap.L7Layer({
        type: 'LineLayer',
        options: { blend: 'normal' },
      });
      linelayer
        .getL7Layer()
        .source(data, {
          parser: {
            type: 'csv',
            x: 'lng1',
            y: 'lat1',
            x1: 'lng2',
            y1: 'lat2',
          },
        })
        .size(1)
        .shape('arc')
        .color('red')
        .animate({
          enable: true,
          duration: 4,
          interval: 0.2,
          trailLength: 0.6,
        });
      map.addLayer(linelayer);
    });
}
// 直线动画 不显示
function createLineAnimate(map) {
  fetch('./js/UEXQMifxtkQlYfChpPwT1.txt')
    .then((res) => res.text())
    .then((data) => {
      var layer = new mapboxgl.supermap.L7Layer({
        type: 'LineLayer',
        options: {
          blend: 'normal',
        },
      });
      var l7Layer = layer.getL7Layer();
      l7Layer
        .source(data, {
          parser: {
            type: 'csv',
            x: 'lng1',
            y: 'lat1',
            x1: 'lng2',
            y1: 'lat2',
          },
        })
        .size(10)
        .shape('greatcircle')
        .animate({
          enable: true,
          interval: 0.1,
          trailLength: 0.5,
          duration: 2,
        })
        .color('#8C1EB2')
        .style({
          opacity: 0.8,
        });
      map.addLayer(layer);
    });
}

// OD图
function createOD(map, scene) {
  scene.addImage(
    'plane',
    'https://gw.alipayobjects.com/zos/bmw-prod/0ca1668e-38c2-4010-8568-b57cb33839b9.svg',
  );
  Promise.all([
    fetch(
      'https://gw.alipayobjects.com/os/bmw-prod/2960e1fc-b543-480f-a65e-d14c229dd777.json',
    ).then((d) => d.json()),
    fetch(
      'https://gw.alipayobjects.com/os/basement_prod/4472780b-fea1-4fc2-9e4b-3ca716933dc7.json',
    ).then((d) => d.text()),
    fetch(
      'https://gw.alipayobjects.com/os/basement_prod/a5ac7bce-181b-40d1-8a16-271356264ad8.json',
    ).then((d) => d.text()),
  ]).then(function onLoad([world, dot, flyline]) {
    const dotData = eval(dot);
    // @ts-ignore
    const flydata = eval(flyline).map((item) => {
      // @ts-ignore
      const latlng1 = item.from.split(',').map((e) => {
        return e * 1;
      });
      // @ts-ignore
      const latlng2 = item.to.split(',').map((e) => {
        return e * 1;
      });
      return { coord: [latlng1, latlng2] };
    });

    var worldLine = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' });
    var l7Layer = worldLine.getL7Layer();
    l7Layer.source(world).color('#41fc9d').size(0.5).style({
      opacity: 0.4,
    });

    var dotPoint = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
    dotPoint
      .getL7Layer()
      .source(dotData, {
        parser: {
          type: 'json',
          x: 'lng',
          y: 'lat',
        },
      })
      .shape('circle')
      .color('#ffed11')
      .animate(true)
      .size(40);

    var flyLine = new mapboxgl.supermap.L7Layer({
      type: 'LineLayer',
      options: { blend: 'normal' },
    });
    flyLine
      .getL7Layer()
      .source(flydata, {
        parser: {
          type: 'json',
          coordinates: 'coord',
        },
      })
      .color('#ff6b34')
      .texture('plane')
      .shape('arc')
      .size(15)
      .animate({
        duration: 1,
        interval: 0.2,
        trailLength: 0.05,
      })
      .style({
        textureBlend: 'replace',
        lineTexture: true, // 开启线的贴图功能
        iconStep: 10, // 设置贴图纹理的间距
      });
    var flyLine2 = new mapboxgl.supermap.L7Layer({
      type: 'LineLayer',
      options: { blend: 'normal' },
    });
    flyLine2
      .getL7Layer()
      .source(flydata, {
        parser: {
          type: 'json',
          coordinates: 'coord',
        },
      })
      .color('#ff6b34')
      .shape('arc')
      .size(1)
      .style({
        lineType: 'dash',
        dashArray: [5, 5],
        opacity: 0.5,
      });
    map.addLayer(worldLine);
    map.addLayer(dotPoint);
    map.addLayer(flyLine2);
    map.addLayer(flyLine);
  });
}
        // OD图
function createOD_MS(map, scene) {
  scene.addImage(
    'plane',
    'https://gw.alipayobjects.com/zos/bmw-prod/0ca1668e-38c2-4010-8568-b57cb33839b9.svg',
  );

  fetch('./datas/flight.json')
    .then((d) => d.json())
    .then((data) => {
      var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' });
      var l7Layer = layer.getL7Layer();
      l7Layer
        .source(data, {
          parser: {
            type: 'json',
            x: '起飞机场x',
            y: '起飞机场y',
            x1: '到达城市x',
            y1: '到达城市y',
          },
        })
        .shape('greatcircle')
        .color('#ff6b34')
        .size(1)
        .style({
          lineType: 'dash',
          dashArray: [1, 0],
          opacity: 1,
          segmentNumber: 50,
        });
      map.addLayer(layer);

      var layer2 = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' });
      layer2
        .getL7Layer()
        .source(data, {
          parser: {
            type: 'json',
            x: '起飞机场x',
            y: '起飞机场y',
            x1: '到达城市x',
            y1: '到达城市y',
          },
        })
        .color('red')
        .texture('plane')
        .shape('greatcircle')
        .size(50)
        .animate({
          duration: 5,
          interval: 0.2,
          trailLength: 0.05,
        })
        .style({
          segmentNumber: 50,
          textureBlend: 'replace',
          lineTexture: true, // 开启线的贴图功能
          iconStep: 10, // 设置贴图纹理的间距
        });
      map.addLayer(layer2);
    });
}

       
        function addChart(scene, map) {
  fetch(
    'https://gw.alipayobjects.com/os/basement_prod/0b96cca4-7e83-449a-93d0-2a77053e74ab.json',
  )
    .then((res) => res.json())
    .then((data) => {
      const nodes = [{
          "gdp": {
              "Agriculture": 208995,
              "Industry": 3326504,
              "Service": 13880754
          },
          "name": "United States of America",
          "coordinates": [108.9131417, 23.826245],
          "id": "United States of America"
      },
      {
          "gdp": {
              "Agriculture": 208995,
              "Industry": 3326504,
              "Service": 13880754
          },
          "name": "United States of America",
          "coordinates":[108.85, 23.85],
          "id": "United States of America"
      }]
      nodes.forEach(function (item) {
        const el = document.createElement('div');
        const total =
          item.gdp.Agriculture + item.gdp.Industry + item.gdp.Service;
        const coordinates = item.coordinates;
        // new mapboxgl.Marker().setLngLat(coordinates).addTo(map);

        const size = Math.min(parseInt(total / 30000, 10), 70);
        // if (size < 30) {
        //   return;
        // }
        const itemData = [
          {
            item: 'Agriculture',
            count: item.gdp.Agriculture,
            percent: item.gdp.Agriculture / total,
          },
          {
            item: 'Industry',
            count: item.gdp.Industry,
            percent: item.gdp.Industry / total,
          },
          {
            item: 'Service',
            count: item.gdp.Service,
            percent: item.gdp.Service / total,
          },
        ];

        const chart = new G2.Chart({
          container: el,
          width: size,
          height: size,
          render: 'svg',
          padding: 0,
        });
        chart.legend(false);
        chart.data(itemData);
        chart.tooltip(false);

        chart.axis('count', false);
        chart.axis('item', false);
        chart
          .interval()
          .position('item*count')
          .color('item', ['#5CCEA1', '#5D7092', '#5B8FF9']);
        chart.render();
        const marker = new L7.Marker({
          element: el,
        }).setLnglat({
          lng: item.coordinates[0],
          lat: item.coordinates[1],
        });
        scene.addMarker(marker);
      });
    });
}

       
         function creatRain(data, map) {
          var layer = new mapboxgl.supermap.L7Layer({ type: 'GeometryLayer' });
          var l7Layer = layer.getL7Layer();
          l7Layer
            .shape('sprite')
            .size(10)
            .style({
              // opacity: 0.5,
              mapTexture: './js/A_w2SFSZJp4nIAAAAAAAAAAAAAARQnAQ.png', // rain
              center: [108.91314171858397, 23.826244669161124],
              spriteCount: 6000,
              spriteRadius: 100,
              spriteTop: 2500000,
              spriteUpdate: 20000,
              // spriteScale: 0.6,
            });
          map.addLayer(layer);
        }
        function createCityBuildings(data, map) {
          fetch(
            'https://gw.alipayobjects.com/os/basement_prod/972566c5-a2b9-4a7e-8da1-bae9d0eb0117.json'
        )
        .then(res => res.json())
        .then(data => {
              var layer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer',options:{ autoFit: true }  });
              var l7Layer = layer.getL7Layer();
                l7Layer
                .source(data)
                .shape('extrude')
                .size(100)
                .color('h20', [
                  '#816CAD',
                  '#A67FB5',
                  '#C997C7',
                  '#DEB8D4',
                  '#F5D4E6',
                  '#FAE4F1',
                  '#FFF3FC'
                ])
                // .style({heightfixed: true});
              map.addLayer(layer);
          })
       }

        function createWater(data, map) {
          fetch(
            'https://gw.alipayobjects.com/os/bmw-prod/67130c6c-7f49-4680-915c-54e69730861d.json'
        )
        .then(data => data.json())
        .then(({ lakeData }) => {
          
            var layer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer',options:{ autoFit: true } });
              var l7Layer = layer.getL7Layer();
                l7Layer
                .source(data)
                .shape('water')
                .color('#1E90FF')
                .style({
                  speed: 0.4
                  // waterTexture: 'https://gw.alipayobjects.com/mdn/rms_816329/afts/img/A*EojwT4VzSiYAAAAAAAAAAAAAARQnAQ'
                })
                .animate(true);
              map.addLayer(layer);
          })
       }


        function createOcean(data, map) {
          fetch(
            'https://gw.alipayobjects.com/os/bmw-prod/67130c6c-7f49-4680-915c-54e69730861d.json'
        )
        .then(data => data.json())
        .then(({ lakeData }) => {
              var layer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer',options:{ autoFit: true } });
              var l7Layer = layer.getL7Layer();
                l7Layer
                .source(data)
                .shape('ocean')
                .color('#1E90FF')
                .style({
                  watercolor: '#6D99A8'
                  // watercolor: '#0f0',
                })
                .animate(true);

              map.addLayer(layer);
          })
       }

      function create3DColumnLayer(data, map) {
          var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
          var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
            parser: {
              type: 'json',
              x: 'j',
              y: 'w'
            }
          }).shape('name', [
            'cylinder',
            'triangleColumn',
            'hexagonColumn',
            'squareColumn'
          ])
          .size('h', h => {
            return [ 6, 6, h / 500 ];
          })
          .color('name', [ '#739DFF', '#61FCBF', '#FFDE74', '#FF896F' ]);
          map.addLayer(layer);
      }
   
     function createShpePoint(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('name', [
          'circle',
          'triangle',
          'square',
          'pentagon',
          'hexagon',
          'octogon',
          'hexagram',
          'rhombus',
          'vesica'
        ])
        .size('l', [ 10, 25 ])
        .active(true)
        .color('name', [ '#5B8FF9', '#5CCEA1', '#5D7092', '#F6BD16', '#E86452' ])
        .style({
          opacity: 0.8,
          strokeWidth: 2
        });
        map.addLayer(layer);
     }
   
     function createAnimatePoint(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('circle')
        .active(true)
        .animate(true)
        .size(40)
        .color('#ffa842')
        .style({
          // offsets: [ 40, 40 ]
        });
        map.addLayer(layer);
     }

     function creatRadarPoint(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('radar')
        .size(100)
        .color('#d00')
        .style({
          speed: 5
        })
        .animate(true);
        map.addLayer(layer);
     }
   
     function creatTextPoint(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('name', 'text')
        .size(50)
        .color('#084081')
        .style({
          textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
          textOffset: [ 0, 0 ], // 文本相对锚点的偏移量 [水平, 垂直]
          spacing: 2, // 字符间距
          padding: [ 1, 1 ], // 文本包围盒 padding [水平，垂直]，影响碰撞检测结果，避免相邻文本靠的太近
          stroke: '#ffffff', // 描边颜色
          strokeWidth: 2, // 描边宽度
          strokeOpacity: 1.0,
          // rotation: 60, // 常量旋转
          rotation:{ // 字段映射旋转
            field: 't',
            value:[30,270]
          }
        });
        map.addLayer(layer);
     }
   
     function creatTextPolygon(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data)
        .color('blue')
        .shape('name', 'text')
        .size(18)
        .style({
          textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
          textOffset: [ 0, 0 ], // 文本相对锚点的偏移量 [水平, 垂直]
          spacing: 2, // 字符间距
          padding: [ 1, 1 ], // 文本包围盒 padding [水平，垂直]，影响碰撞检测结果，避免相邻文本靠的太近
          stroke: '#ffffff', // 描边颜色
          strokeWidth: 0.3, // 描边宽度
          strokeOpacity: 1.0
        });
        map.addLayer(layer);
     }

     function creatIconPoint(data, map) {
      map.getL7Scene().then(scene=>{
        const fontFamily = 'iconfont';
        const fontPath = '//at.alicdn.com/t/font_2534097_fcae9o2mxbv.woff2?t=1622200439140';
        scene.addFontFace(fontFamily, fontPath);
        scene.addIconFont('icon1', '&#xe6d4;');
        scene.once('fontloaded', () => {
          var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
          var l7Layer = layer.getL7Layer();
            l7Layer.source(data, {
            parser: {
              type: 'json',
              x: 'j',
              y: 'w'
            }
          })
          .shape('icon', 'text')
          .size(20)
          .color('blue')
          .style({
            textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
            // padding: [ 0, 0 ], // 文本包围盒 padding [水平，垂直]，影响碰撞检测结果，避免相邻文本靠的太近
            stroke: '#ffffff', // 描边颜色
            fontFamily,
            iconfont: true,
            textAllowOverlap: true
          });
          map.addLayer(layer);
        })
      })
     }
   
     function creatIconTempPoint(data, map) {
      map.getL7Scene().then(scene=>{
        const fontFamily = 'iconfont';
        const fontPath =
          '//at.alicdn.com/t/font_2534097_x6rsov3i1g.woff2?t=1622107341225';
        scene.addIconFont('icon1', '&#xe69e;');
        scene.addFontFace(fontFamily, fontPath);

        const colors = [
          '#87CEFA',
          '#00BFFF',

          '#7FFFAA',
          '#00FF7F',
          '#32CD32',

          '#F0E68C',
          '#FFD700',

          '#FF7F50',
          '#FF6347',
          '#FF0000'
        ];

        scene.once('fontloaded', () => {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('icon', 'text')
        .size(25)
        .style({
          textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
          textOffset: [ -25, 15 ],
          padding: [ 2, 2 ],
          fontFamily,
          iconfont: true,
          textAllowOverlap: true
        });
        map.addLayer(layer);
      })
      })
     }
   
     function creatImagePoint(data, map) {
      map.getL7Scene().then(scene=>{
        scene.addImage(
          '00',
          'https://gw.alipayobjects.com/zos/basement_prod/604b5e7f-309e-40db-b95b-4fac746c5153.svg'
        );
        scene.addImage(
          '01',
          'https://gw.alipayobjects.com/zos/basement_prod/30580bc9-506f-4438-8c1a-744e082054ec.svg'
        );
        scene.addImage(
          '02',
          'https://gw.alipayobjects.com/zos/basement_prod/7aa1f460-9f9f-499f-afdf-13424aa26bbf.svg'
        );

        var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer.source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .shape('name', [ '00', '01', '02' ])
        .size(50);
        map.addLayer(layer);
      })
     }

     function creatPathLine(data, map) {
     
      var data1 = [
        {
          "level": 2,
          "number": "902",
          "path": [
            [
            108.9131417, 23.826245,
              4
            ],
            [
            108.85, 23.85,
              4
            ]
          ]
        }
      ]
        var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data1, {
          parser: {
            type: 'json',
            coordinates: 'path'
          }
        })
          .size('level', level => {
            return [ 0.8, level * 0.1 ];
          })
        .shape('line')
        .active(true)
        .color('number', [
          '#0A3663',
          '#1558AC',
          '#3771D9',
          '#4D89E5',
          '#64A5D3',
          '#72BED6',
          '#83CED6',
          '#A6E1E0',
          '#B8EFE2',
          '#D7F9F0'
        ]);
        map.addLayer(layer);
     }
   
     function crea3dArcLine(data, map) {
      // [108.9131417, 23.826245],
      //               [108.85, 23.85]
      var data1 = [
            {
          "tripduration": 452,
          "starttime": "2017-12-01 00:00:59",
          "stoptime": "2017-12-01 00:08:32",
          "start station id": 3183,
          "start station name": "Exchange Place",
          "start station latitude": 23.826245,
          "start station longitude": 108.9131417,
          "end station id": 3199,
          "end station name": "Newport Pkwy",
          "end station latitude": 23.85,
          "end station longitude": 108.85,
          "bikeid": 29607,
          "usertype": "Subscriber",
          "birth year": 1988,
          "gender": 1
        },
      ]
        var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' ,options:{ blend: 'normal'}}, );
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data1, {
          parser: {
            type: 'json',
            x: 'start station longitude',
            y: 'start station latitude',
            x1: 'end station longitude',
            y1: 'end station latitude'
          }
        })
        .size(2)
        .shape('arc3d')
        .color('red')
        // .animate({
        //   interval: 0.5,
        //   trailLength: 0.5,
        //   duration: 5
        // })
        .style({
          opacity: 1
        });
        map.addLayer(layer);
     }
   
     function creahighLine(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' ,options:{ blend: 'normal'}}, );
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data)
        .scale('value', {
          type: 'quantile'
        })
        .size('value', [ 0.5, 1, 1.5, 2 ])
        .shape('line')
        .color(
          'value',
          [
            '#0A3663',
            '#1558AC',
            '#3771D9',
            '#4D89E5',
            '#64A5D3',
            '#72BED6',
            '#83CED6',
            '#A6E1E0',
            '#B8EFE2',
            '#D7F9F0'
          ].reverse()
        );
        map.addLayer(layer);
     }

     function creaWallLine(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'LineLayer' ,options:{ blend: 'normal'}}, );
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data)
          .size(40)
        .shape('wall')
        .style({
          heightfixed: true,
          opacity: 1,
          sourceColor: '#0DCCFF',
          targetColor: 'rbga(255,255,255, 0)'
        });
        map.addLayer(layer);
     }
   
     function crea3DExtrude(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data)
          .shape('extrude')
          .size(100)
          .color('red')
          // .style({
          //   heightfixed: true
          // });
        map.addLayer(layer);
     }

     function createHeat(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data,{parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }})
          .shape('heatmap')
        .size('mag', [ 0, 1.0 ]) // weight映射通道
        .style({
          intensity: 2,
          radius: 20,
          rampColors: {
            colors: [
              '#FF4818',
              '#F7B74A',
              '#FFF598',
              '#91EABC',
              '#2EA9A1',
              '#206C7C'
            ].reverse(),
            positions: [ 0, 0.2, 0.4, 0.6, 0.8, 1.0 ]
          }
        });
        map.addLayer(layer);
     }

     function createheatmap3D(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data,{
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          }
        })
        .size('capacity', [ 0, 1 ])
        .shape('heatmap3D')
      // weight映射通道
        .style({
          intensity: 5,
          radius: 10,
          rampColors: {
            colors: [
              '#2E8AE6',
              '#69D1AB',
              '#DAF291',
              '#FFD591',
              '#FF7A45',
              '#CF1D49'
            ],
            positions: [ 0, 0.2, 0.4, 0.6, 0.8, 1.0 ]
          }
        });
        map.addLayer(layer);
     }
   
     function creatTextPoint(data, map) {
            console.log('creatTextPoint')
            var layer = new mapboxgl.supermap.L7Layer({ type: 'PointLayer' });
            var l7Layer = layer.getL7Layer();
              l7Layer
              .source(data, {
                parser: {
                  type: 'json',
                  x: 'j',
                  y: 'w'
                }
              })
            .shape('name', 'text')
            .size(50)
            .color('red')
            .style({
              textAnchor: 'center', // 文本相对锚点的位置 center|left|right|top|bottom|top-left
              textOffset: [ 0, 0 ], // 文本相对锚点的偏移量 [水平, 垂直]
              spacing: 2, // 字符间距
              padding: [ 1, 1 ], // 文本包围盒 padding [水平，垂直]，影响碰撞检测结果，避免相邻文本靠的太近
              stroke: '#ffffff', // 描边颜色
              strokeWidth: 2, // 描边宽度
              strokeOpacity: 1.0,
              rotation: 0, // 常量旋转
              // rotation:{ // 字段映射旋转
              //   field: 't',
              //   value:[30,270]
              // }
            });
            map.addLayer(layer);
          }
   
     function creategrid(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          },
          transforms: [
            {
              type: 'grid',
              size: 200,
              field: 'v',
              method: 'sum'
            }
          ]
        })
        .shape('square')
        .style({
          coverage: 1,
          angle: 0
        })
        .color('red');
        map.addLayer(layer);
     }
  

     function creategrid(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          },
          transforms: [
            {
              type: 'hexagon',
              size: 200,
              field: 'v',
              method: 'sum'
            }
          ]
        })
        .shape('hexagon')
        .style({
          coverage: 1,
          angle: 0
        })
        .color('red');
        map.addLayer(layer);
     }
  
     function creategrid3D(data, map) {
        var layer = new mapboxgl.supermap.L7Layer({ type: 'HeatmapLayer' });
        var l7Layer = layer.getL7Layer();
          l7Layer
          .source(data, {
          parser: {
            type: 'json',
            x: 'j',
            y: 'w'
          },
          transforms: [
            {
              type: 'hexagon',
              size: 250,
              field: 'v',
              method: 'sum'
            }
          ]
        })
        .size('sum', [ 0, 600 ])
        .shape('hexagonColumn')
        .style({
          coverage: 0.8,
          angle: 0,
        })
        .color('sum', [
          '#094D4A',
          '#146968',
          '#1D7F7E',
          '#289899',
          '#34B6B7',
          '#4AC5AF',
          '#5FD3A6',
          '#7BE39E',
          '#A1EDB8',
          '#C3F9CC',
          '#DEFAC0',
          '#ECFFB1'
        ]);
        map.addLayer(layer);
     }
  
     function createMvtLayer(map) {
        const url = 'https://mvt.amap.com/district/CHN2/{z}/{x}/{y}/4096?key=309f07ac6bc48160e80b480ae511e1e9&version=';
          const source = new L7.Source(url, {
            parser: {
              type: 'mvt',
              tileSize: 256,
              warp: false
            }
          });
          const colors = {};
          const GDPSpeed = {
            520000: 10, //贵州
            540000: 10, //西藏
            530000: 8.5, //云南
            500000: 8.5, //重庆
            360000: 8.5, //江西
            340000: 8.0, //安徽
            510000: 7.5, //四川
            350000: 8.5, //福建
            430000: 8.0, //湖南
            420000: 7.5, //湖北
            410000: 7.5, //河南
            330000: 7.0, //浙江
            640000: 7.5, //宁夏
            650000: 7.0, //新疆
            440000: 7.0, //广东
            370000: 7.0, //山东
            450000: 7.3, //广西
            630000: 7.0, //青海
            320000: 7.0, //江苏
            140000: 6.5, //山西
            460000: 7, // 海南
            310000: 6.5, //上海
            110000: 6.5, // 北京
            130000: 6.5, // 河北
            230000: 6, // 黑龙江
            220000: 6, // 吉林
            210000: 6.5, //辽宁
            150000: 6.5, //内蒙古
            120000: 5, // 天津
            620000: 6, // 甘肃
            610000: 8.5, // 甘肃
            710000: 6.64, //台湾
            810000: 6.0, //香港
            820000: 6.7 //澳门
          };
          const getColorByDGP = function (adcode) {
            if (!colors[adcode]) {
              const gdp = GDPSpeed[adcode];
              if (!gdp) {
                colors[adcode] = 'rgb(227,227,227)';
              } else {
                const rg = 255 - Math.floor(((gdp - 5) / 5) * 255);
                colors[adcode] = 'rgb(' + rg + ',' + rg + ',255)';
              }
            }
            return colors[adcode];
          };
          var fill = new mapboxgl.supermap.L7Layer({ type: 'PolygonLayer', options: { sourceLayer: 'CHN_Cities' } });
          fill.getL7Layer().source(source).shape('fill').color('adcode_pro', getColorByDGP);

          var line = new mapboxgl.supermap.L7Layer({ type: 'LineLayer', options: { sourceLayer: 'CHN_Cities_L' } });
          line.getL7Layer().source(source).shape('line').color('#FFA500');

          var line2 = new mapboxgl.supermap.L7Layer({ type: 'LineLayer', options: { sourceLayer: 'CHN_L' } });
          line2.getL7Layer().source(source).shape('line').size(0.6).color('#053061');

          var line3 = new mapboxgl.supermap.L7Layer({
            type: 'PointLayer',
            options: { sourceLayer: 'CHN_Cities', blend: 'normal' }
          });
          line3.getL7Layer().source(source).shape('id', 'text').size(12).color('#000');

          map.addLayer(fill);
          map.addLayer(line);
          map.addLayer(line2);
          map.addLayer(line3);
      }
    
    </script>
  </body>
</html>
